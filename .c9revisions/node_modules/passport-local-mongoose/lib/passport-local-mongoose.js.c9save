{"ts":1355013993965,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"var crypto = require('crypto');\n\nmodule.exports = function(schema, options) {\n    options = options || {};\n    options.saltlen = options.saltlen || 32;\n    options.iterations = options.iterations || 25000;\n    options.keylen = options.keylen || 512;\n\n    schema.add({ username : String, hash: String, salt: String });\n\n    schema.methods.setPassword = function (password, cb) {\n        if (!password) {\n            return cb(new Error(\"Password argument not set!\"));\n        }\n        \n        var self = this;\n\n        crypto.randomBytes(options.saltlen, function(err, buf) {\n            if (err) {\n                return cb(err);\n            }\n\n            var salt = buf.toString('hex');\n\n            crypto.pbkdf2(password, salt, options.iterations, options.keylen, function(err, hashRaw) {\n                if (err) {\n                    return cb(err);\n                }\n\n                var hash = new Buffer(hashRaw).toString('hex');\n\n                self.hash = hash;\n                self.salt = salt;\n\n                cb(null, self);\n            });\n        });\n    }\n\n    schema.methods.authenticate = function(password, cb) {\n        var self = this;\n\n        // TODO: Fix callback and behavior to match passport\n        crypto.pbkdf2(password, this.salt, options.iterations, options.keylen, function(err, hashRaw) {\n            if (err) {\n                return cb(err);\n            }\n            \n            var hash = new Buffer(hashRaw).toString('hex');\n\n            if (hash === self.hash) {\n                return cb(null, self);\n            } else {\n                return cb(null, false, { message: 'Incorrect password' });\n            }\n        });\n    }\n\n    schema.statics.authenticate = function() {\n        var self = this;\n\n        return function(username, password, cb) {\n            self.findOne({ username: username }, function(err, user) {\n                if (err) { return cb(err); }\n    \n                if (user) {\n                    return user.authenticate(password, cb);\n                } else {\n                    return cb(null, false, { message: 'Incorrect username' })\n                }\n            });\n        }\n    }\n\n    schema.statics.serializeUser = function() {\n        return function(user, cb) {\n            cb(null, user.username);\n        }\n    }\n\n    schema.statics.deserializeUser = function() {\n        var self = this;\n        \n        return function(username, cb) {\n            self.findOne({ username: username }, cb);\n        }\n    }\n}\n"]],"start1":0,"start2":0,"length1":0,"length2":2497}]],"length":2497}
{"contributors":[],"silentsave":true,"ts":1355085971840,"patch":[[{"diffs":[[0,"password, cb) {\n"],[1,"            \n"],[0,"            self"]],"start1":1784,"start2":1784,"length1":32,"length2":45}]],"length":2510,"saved":false}
{"ts":1355085975400,"patch":[[{"diffs":[[0,") {\n            "],[1,"console.log"],[0,"\n            sel"]],"start1":1796,"start2":1796,"length1":32,"length2":43}]],"length":2521,"saved":false}
{"ts":1355085976394,"patch":[[{"diffs":[[0,"sole.log"],[1,"(\"\")"],[0,"\n       "]],"start1":1815,"start2":1815,"length1":16,"length2":20}]],"length":2525,"saved":false}
{"ts":1355085981790,"patch":[[{"diffs":[[0,"le.log(\""],[1,"au"],[0,"\")\n     "]],"start1":1817,"start2":1817,"length1":16,"length2":18}]],"length":2527,"saved":false}
{"ts":1355085982773,"patch":[[{"diffs":[[0,".log(\"au"],[1,"th"],[0,"\")\n     "]],"start1":1819,"start2":1819,"length1":16,"length2":18}]],"length":2529,"saved":false}
{"ts":1355085984557,"patch":[[{"diffs":[[0,"og(\"auth"],[1,"entic"],[0,"\")\n     "]],"start1":1821,"start2":1821,"length1":16,"length2":21}]],"length":2534,"saved":false}
{"ts":1355085985618,"patch":[[{"diffs":[[0,"uthentic"],[1,"ate"],[0,"\")\n     "]],"start1":1826,"start2":1826,"length1":16,"length2":19}]],"length":2537,"saved":false}
{"ts":1355085986871,"patch":[[{"diffs":[[0,"enticate"],[1," cb:"],[0,"\")\n     "]],"start1":1829,"start2":1829,"length1":16,"length2":20}]],"length":2541,"saved":false}
{"ts":1355085988247,"patch":[[{"diffs":[[0,"ate cb:\""],[1," +"],[0,")\n      "]],"start1":1834,"start2":1834,"length1":16,"length2":18}]],"length":2543,"saved":false}
{"ts":1355085989822,"patch":[[{"diffs":[[0,"e cb:\" +"],[1," type"],[0,")\n      "]],"start1":1836,"start2":1836,"length1":16,"length2":21}]],"length":2548,"saved":false}
{"ts":1355085992230,"patch":[[{"diffs":[[0,"\" + type"],[1,"of cb"],[0,")\n      "]],"start1":1841,"start2":1841,"length1":16,"length2":21}]],"length":2553,"saved":false}
{"ts":1355085995168,"patch":[[{"diffs":[[0,"peof cb)"],[1,";"],[0,"\n       "]],"start1":1847,"start2":1847,"length1":16,"length2":17}]],"length":2554,"saved":false}
{"ts":1355086084108,"patch":[[{"diffs":[[0,") {\n"],[-1,"            console.log(\"authenticate cb:\" + typeof cb);\n"],[0,"    "]],"start1":1796,"start2":1796,"length1":65,"length2":8}]],"length":2497,"saved":false}
{"ts":1355086085049,"patch":[[{"diffs":[[0,"ar self = this;\n"],[1,"            console.log(\"authenticate cb:\" + typeof cb);"],[0,"\n        return "]],"start1":1733,"start2":1733,"length1":32,"length2":88}]],"length":2553,"saved":false}
{"ts":1355086088064,"patch":[[{"diffs":[[0,"        "],[-1,"    "],[0,"console."]],"start1":1749,"start2":1749,"length1":20,"length2":16}]],"length":2549,"saved":false}
{"ts":1355086096191,"patch":[[{"diffs":[[0,"cb:\""],[-1," + typeof cb"],[0,");\n "]],"start1":1783,"start2":1783,"length1":20,"length2":8}]],"length":2537,"saved":false}
{"ts":1355086099343,"patch":[[{"diffs":[[0,"cate"],[-1," cb:"],[0,"\");\n"]],"start1":1778,"start2":1778,"length1":12,"length2":8}]],"length":2533,"saved":false}
{"ts":1355086133110,"patch":[[{"diffs":[[0,"is;\n"],[-1,"        console.log(\"authenticate\");\n"],[0,"    "]],"start1":1745,"start2":1745,"length1":45,"length2":8}]],"length":2496,"saved":false}
{"ts":1355086136022,"patch":[[{"diffs":[[0,"password, cb) {\n"],[1,"                    console.log(\"authenticate\");\n"],[0,"            self"]],"start1":1783,"start2":1783,"length1":32,"length2":81}]],"length":2545,"saved":false}
{"ts":1355086136943,"patch":[[{"diffs":[[0,"        "],[-1,"    "],[0,"console."]],"start1":1807,"start2":1807,"length1":20,"length2":16}]],"length":2541,"saved":false}
{"ts":1355086138744,"patch":[[{"diffs":[[0,"        "],[-1,"    "],[0,"console."]],"start1":1803,"start2":1803,"length1":20,"length2":16}]],"length":2537,"saved":false}
{"ts":1355086142302,"patch":[[{"diffs":[[0,"enticate"],[1," callback: "],[0,"\");\n    "]],"start1":1828,"start2":1828,"length1":16,"length2":27}]],"length":2548,"saved":false}
{"ts":1355086143337,"patch":[[{"diffs":[[0,"lback: \""],[1," + "],[0,");\n     "]],"start1":1840,"start2":1840,"length1":16,"length2":19}]],"length":2551,"saved":false}
{"ts":1355086144481,"patch":[[{"diffs":[[0,"ck: \" + "],[1,"type"],[0,");\n     "]],"start1":1843,"start2":1843,"length1":16,"length2":20}]],"length":2555,"saved":false}
{"ts":1355086145480,"patch":[[{"diffs":[[0,"\" + type"],[1,"of "],[0,");\n     "]],"start1":1847,"start2":1847,"length1":16,"length2":19}]],"length":2558,"saved":false}
{"ts":1355086146474,"patch":[[{"diffs":[[0," typeof "],[1,"cb"],[0,");\n     "]],"start1":1850,"start2":1850,"length1":16,"length2":18}]],"length":2560,"saved":false}
{"ts":1355086225667,"patch":[[{"diffs":[[0,"    "],[-1,"    console.log(\"authenticate callback: \" + typeof cb);"],[0,"\n   "]],"start1":1803,"start2":1803,"length1":63,"length2":8}]],"length":2505,"saved":false}
{"ts":1355086228200,"patch":[[{"diffs":[[0,", cb) {\n"],[-1,"        \n"],[0,"        "]],"start1":1791,"start2":1791,"length1":25,"length2":16}]],"length":2496,"saved":false}
{"ts":1355086235162,"patch":[[{"diffs":[[0,"  }\n"],[-1,"            \n"],[0,"    "]],"start1":1393,"start2":1393,"length1":21,"length2":8}]],"length":2483,"saved":false}
{"ts":1355086243490,"patch":[[{"diffs":[[0,"       } else {\n"],[1,"                    console.log(\"authenticate callback: \" + typeof cb);\n"],[0,"                "]],"start1":2004,"start2":2004,"length1":32,"length2":104}]],"length":2555,"saved":false}
{"ts":1355086253107,"patch":[[{"diffs":[[0,"       } else {\n"],[1,"                console.log(\"authenticate callback: \" + typeof cb);\n"],[0,"                "]],"start1":1540,"start2":1540,"length1":32,"length2":100}]],"length":2623,"saved":false}
{"ts":1355086336221,"patch":[[{"diffs":[[0,"e {\n"],[-1,"                console.log(\"authenticate callback: \" + typeof cb);\n"],[0,"    "]],"start1":1552,"start2":1552,"length1":76,"length2":8}]],"length":2555,"saved":false}
{"ts":1355086340847,"patch":[[{"diffs":[[0,"e {\n"],[-1,"                    console.log(\"authenticate callback: \" + typeof cb);\n"],[0,"    "]],"start1":2016,"start2":2016,"length1":80,"length2":8}]],"length":2483,"saved":false}
{"ts":1355086443491,"patch":[[{"diffs":[[0,";\n            }\n"],[1,"            \n"],[0,"            var "]],"start1":1381,"start2":1381,"length1":32,"length2":45},{"diffs":[[0,"ar self = this;\n"],[1,"\n"],[0,"        return f"]],"start1":1733,"start2":1733,"length1":32,"length2":33},{"diffs":[[0,"password, cb) {\n"],[1,"            console.log(\"authenticate cb:\" + typeo)\n"],[0,"            self"]],"start1":1784,"start2":1784,"length1":32,"length2":84}]],"length":2549,"saved":false}
{"ts":1355086444560,"patch":[[{"diffs":[[0,"ole."],[-1,"log(\"authenticate cb:\" + typeo)"],[0,"\n   "]],"start1":1816,"start2":1816,"length1":39,"length2":8}]],"length":2518,"saved":false}
{"ts":1355086447903,"patch":[[{"diffs":[[0,") {\n"],[-1,"            console.\n"],[0,"    "]],"start1":1796,"start2":1796,"length1":29,"length2":8}]],"length":2497,"saved":false}
